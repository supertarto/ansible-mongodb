---
- name: Determine major version
  set_fact:
    mongodb_major_version: "{{ mongodb_version[0:3] }}"

- name: Install Requisites
  package:
    name: ["python-pip", "ca-certificates", "python-setuptools"]
    state: present

- name: Install PyMongo from PIP
  pip:
    name: pymongo
    state: "present"

- name: Add APT key
  apt_key:
    keyserver: "{{ mongodb_apt_keyserver }}"
    id: "{{ mongodb_apt_key_id[mongodb_major_version] }}"

- name: Add APT repository for MongoDB
  apt_repository:
    repo: "{{ mongodb_repository[mongodb_major_version] }}"
    filename: mongodb_rep
    state: present

- name: Update apt cache.
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install MongoDB package
  package:
    name: "{{ mongodb_package }}{% if (mongodb_version | length > 3) %}={{ mongodb_version }}{% endif %}"
    state: present
    update_cache: true

- name: Install numactl package
  package:
    name: numactl
    state: present

- name: Hold MongoDB version (Debian)
  dpkg_selections:
    name: "{{ mongodb_package }}"
    selection: "hold"
  when: mongodb_version_lock

- name: Add systemd configuration if present
  copy:
    src: "mongodb.service"
    dest: "/lib/systemd/system/{{ mongodb_daemon_name }}.service"
    owner: root
    group: root
    mode: 0644
  when: ansible_service_mgr == "systemd"
  notify: Reload systemd

- name: Add symlink for systemd
  file:
    src: /lib/systemd/system/{{ mongodb_daemon_name }}.service
    dest: /etc/systemd/system/multi-user.target.wants/{{ mongodb_daemon_name }}.service
    state: link
  when: ansible_service_mgr == "systemd"
  notify: Reload systemd
